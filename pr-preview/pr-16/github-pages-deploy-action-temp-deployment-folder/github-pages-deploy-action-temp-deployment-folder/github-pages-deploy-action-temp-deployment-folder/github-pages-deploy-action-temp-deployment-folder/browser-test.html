<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Browser Test - Nations Navigator</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			.test-section {
				margin: 20px 0;
				padding: 15px;
				border: 1px solid #ddd;
				border-radius: 5px;
			}
			.test-result {
				padding: 10px;
				margin: 10px 0;
				border-radius: 3px;
			}
			.success {
				background-color: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.error {
				background-color: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
			.info {
				background-color: #d1ecf1;
				color: #0c5460;
				border: 1px solid #bee5eb;
			}
			button {
				background-color: #007bff;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 3px;
				cursor: pointer;
				margin: 5px;
			}
			button:hover {
				background-color: #0056b3;
			}
			#results {
				margin-top: 20px;
			}
		</style>
	</head>
	<body>
		<h1>Nations Navigator - Browser Integration Test</h1>

		<div class="test-section">
			<h2>Test 1: Verify Application Loads</h2>
			<p>
				This test checks if the main application loads correctly without errors.
			</p>
			<button onclick="testApplicationLoads()">Run Test</button>
			<div id="test1-result"></div>
		</div>

		<div class="test-section">
			<h2>Test 2: Check Data Loading</h2>
			<p>
				This test verifies that country data and map components are loaded
				properly.
			</p>
			<button onclick="testDataLoading()">Run Test</button>
			<div id="test2-result"></div>
		</div>

		<div class="test-section">
			<h2>Test 3: Test Country Highlighting</h2>
			<p>
				This test checks if countries can be highlighted using the fixed
				highlighting mechanism.
			</p>
			<button onclick="testCountryHighlighting()">Run Test</button>
			<div id="test3-result"></div>
		</div>

		<div class="test-section">
			<h2>Test 4: Complete Integration Test</h2>
			<p>
				This test runs a complete workflow including querying for countries with
				"red" flags.
			</p>
			<button onclick="testCompleteWorkflow()">Run Test</button>
			<div id="test4-result"></div>
		</div>

		<div class="test-section">
			<button onclick="runAllTests()">Run All Tests</button>
			<button onclick="openMainApp()">Open Main Application</button>
		</div>

		<div id="results"></div>

		<script type="module">
			import {
				fetchCountryData,
				initializeAlaSQLTable,
				executeQuery,
			} from "./js/data.js";
			import {
				initMap,
				highlightCountries,
				getFilteredCountries,
			} from "./js/map.js";
			import { initWebLLM, processQuery } from "./js/llm.js";

			let testResults = [];

			window.testApplicationLoads = async function () {
				const resultDiv = document.getElementById("test1-result");
				try {
					resultDiv.innerHTML =
						'<div class="info">Testing application load...</div>';

					// Check if all modules are loaded
					const hasData = typeof fetchCountryData === "function";
					const hasMap = typeof initMap === "function";
					const hasLLM = typeof initWebLLM === "function";

					if (hasData && hasMap && hasLLM) {
						resultDiv.innerHTML =
							'<div class="success">✅ Application modules loaded successfully</div>';
						testResults.push({ test: "Application Load", status: "PASS" });
					} else {
						throw new Error("Missing required modules");
					}
				} catch (error) {
					resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
					testResults.push({
						test: "Application Load",
						status: "FAIL",
						error: error.message,
					});
				}
			};

			window.testDataLoading = async function () {
				const resultDiv = document.getElementById("test2-result");
				try {
					resultDiv.innerHTML =
						'<div class="info">Testing data loading...</div>';

					// Test data loading
					await fetchCountryData();

					// Test query execution
					const result = executeQuery(
						"SELECT name, ISO_A3 FROM countries WHERE region = 'Europe' LIMIT 2"
					);

					if (result && result.length > 0) {
						resultDiv.innerHTML = `<div class="success">✅ Data loaded successfully. Sample: ${result
							.map((r) => r.name)
							.join(", ")}</div>`;
						testResults.push({ test: "Data Loading", status: "PASS" });
					} else {
						throw new Error("No data returned from query");
					}
				} catch (error) {
					resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
					testResults.push({
						test: "Data Loading",
						status: "FAIL",
						error: error.message,
					});
				}
			};

			window.testCountryHighlighting = async function () {
				const resultDiv = document.getElementById("test3-result");
				try {
					resultDiv.innerHTML =
						'<div class="info">Testing country highlighting...</div>';

					// Initialize map first
					await initMap();

					// Wait a moment for map to fully load
					await new Promise((resolve) => setTimeout(resolve, 2000));

					// Test highlighting with a simple condition
					const highlightedCount = highlightCountries((layer) => {
						const iso = layer.feature.properties.ISO_A3;
						return iso === "GBR" || iso === "IRL"; // Test with known countries
					});

					const filteredCountries = getFilteredCountries();

					if (highlightedCount > 0 && filteredCountries.size > 0) {
						resultDiv.innerHTML = `<div class="success">✅ Country highlighting works! Highlighted ${highlightedCount} countries: ${Array.from(
							filteredCountries
						).join(", ")}</div>`;
						testResults.push({ test: "Country Highlighting", status: "PASS" });
					} else {
						throw new Error(
							`No countries highlighted. Count: ${highlightedCount}, Filtered: ${filteredCountries.size}`
						);
					}
				} catch (error) {
					resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
					testResults.push({
						test: "Country Highlighting",
						status: "FAIL",
						error: error.message,
					});
				}
			};

			window.testCompleteWorkflow = async function () {
				const resultDiv = document.getElementById("test4-result");
				try {
					resultDiv.innerHTML =
						'<div class="info">Testing complete workflow...</div>';

					// Initialize all systems
					await fetchCountryData();
					await initMap();
					await initWebLLM();

					// Wait for systems to be ready
					await new Promise((resolve) => setTimeout(resolve, 3000));

					// Test a query that should find countries with red flags
					const result = await processQuery("countries with red in their flag");

					if (result && result.length > 0) {
						const countryNames = result.map((r) => r.name).join(", ");
						resultDiv.innerHTML = `<div class="success">✅ Complete workflow successful! Found countries: ${countryNames}</div>`;
						testResults.push({ test: "Complete Workflow", status: "PASS" });
					} else {
						throw new Error("No results from complete workflow test");
					}
				} catch (error) {
					resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
					testResults.push({
						test: "Complete Workflow",
						status: "FAIL",
						error: error.message,
					});
				}
			};

			window.runAllTests = async function () {
				testResults = [];
				await testApplicationLoads();
				await new Promise((resolve) => setTimeout(resolve, 1000));
				await testDataLoading();
				await new Promise((resolve) => setTimeout(resolve, 1000));
				await testCountryHighlighting();
				await new Promise((resolve) => setTimeout(resolve, 1000));
				await testCompleteWorkflow();

				displayFinalResults();
			};

			window.openMainApp = function () {
				window.open("./index.html", "_blank");
			};

			function displayFinalResults() {
				const resultsDiv = document.getElementById("results");
				const passed = testResults.filter((r) => r.status === "PASS").length;
				const failed = testResults.filter((r) => r.status === "FAIL").length;

				let html = `<h2>Test Summary</h2>`;
				html += `<div class="test-result ${
					failed === 0 ? "success" : "error"
				}">`;
				html += `<strong>Tests Passed: ${passed}/${testResults.length}</strong>`;
				html += `</div>`;

				html += `<h3>Detailed Results:</h3>`;
				testResults.forEach((result) => {
					html += `<div class="test-result ${
						result.status === "PASS" ? "success" : "error"
					}">`;
					html += `<strong>${result.test}:</strong> ${result.status}`;
					if (result.error) {
						html += `<br><em>Error: ${result.error}</em>`;
					}
					html += `</div>`;
				});

				resultsDiv.innerHTML = html;
			}
		</script>
	</body>
</html>
